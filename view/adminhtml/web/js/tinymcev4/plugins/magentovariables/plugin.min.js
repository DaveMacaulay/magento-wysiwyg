window.MagentoVariablesBridge={variables:null,callback:null,open:function(url,callback){this.callback=callback;if(this.variables===null){new Ajax.Request(url,{parameters:{},onComplete:function(transport){if(transport.responseText.isJSON()){window.Variables.init(null,"MagentoVariablesBridge.insertVariable");this.variables=transport.responseText.evalJSON();window.Variables.openVariableChooser(this.variables)}}.bind(this)})}else{window.Variables.openVariableChooser(this.variables)}return false},insertVariable:function(){this.callback.apply(this,arguments);window.Variables.closeDialogWindow()}};tinymce.PluginManager.add("magentovariables",function(editor){function addContextToolbar(){editor.addButton("changevariable",{title:"Change Variable",icon:"editimage",onclick:function(){var currentNode=editor.selection.getNode();MagentoVariablesBridge.open(tinymce.typeConfig.variableActionUrl,function(variable){editor.selection.select(currentNode);editor.execCommand("magentoRemoveVariable");editor.insertContent(variable)})}});editor.addCommand("magentoRemoveVariable",function(){editor.selection.setCursorLocation(editor.selection.getNode(),1);editor.dom.remove(editor.selection.getNode())});editor.addButton("removevariable",{title:"Remove",icon:"remove",cmd:"magentoRemoveVariable"});editor.addContextToolbar(function(node){return selectorMatched=editor.dom.is(node,"span.magento-variable")},"changevariable | removevariable")}if(typeof editor.settings["content_style"]==="undefined"){editor.settings["content_style"]=""}editor.settings["content_style"]=editor.settings["content_style"]+".magento-variable { display: inline-block; font-family:Consolas,Monaco,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New;border: 1px solid #cccccc; padding: 4px; margin: 0 2px;border-radius: 4px; }";editor.addButton("magentovariables",{text:"V",icon:false,onclick:function(){MagentoVariablesBridge.open(tinymce.typeConfig.variableActionUrl,function(variable){editor.insertContent(variable)})}});function wrapConfigNodes(event){event.content=event.content.replace(/\{\{config path=".*"\}\}+(?![^\<span.*>]*\<\/span\>)/g,'<span class="magento-variable mceNonEditable" >$&</span>')}function unwrapConfigNodes(event){event.content=event.content.replace(/\<span.*\>\{\{config path=".*"\}\}\<\/span\>/g,"$1")}editor.on("beforeSetContent",wrapConfigNodes);editor.on("PostProcess",unwrapConfigNodes);addContextToolbar()},["noneditable"]);